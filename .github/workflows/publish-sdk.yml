name: Publish NPM package

on:
    push:
        tags:
            - '*'

permissions:
    contents: read
    packages: write

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version-file: .nvmrc
                  registry-url: 'https://npm.pkg.github.com/'
            - run: yarn install

            - run: yarn build

            - name: Start Thor solo node
              id: start-solo
              run: yarn start-thor-solo

            - name: Run Unit & Integration tests
              run: yarn test

            - name: Stop Thor solo node
              id: stop-solo
              run: yarn stop-thor-solo

            - name: Publish errors
              run: |
                  cd packages/errors
                  yarn version --no-git-tag-version --new-version ${{ github.ref_name }}
                  yarn publish
              env:
                  NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

            - name: Publish core
              run: |
                  cd packages/core
                  yarn version --no-git-tag-version --new-version ${{ github.ref_name }}
                  yarn publish
              env:
                  NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}
                  
            - name: Publish network
              run: |
                  cd packages/network
                  yarn version --no-git-tag-version --new-version ${{ github.ref_name }}
                  yarn publish
              env:
                  NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}
